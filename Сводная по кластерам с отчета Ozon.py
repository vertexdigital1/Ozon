import pandas as pd
from openpyxl import load_workbook
import os


def create_pivot_table():
    """
    –°–æ–∑–¥–∞–µ—Ç —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º –∏–∑ —Ñ–∞–π–ª–∞ Excel.
    –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–π–ª–∞–º–∏, –∏–º–µ—é—â–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç—á–µ—Ç–∞ "–æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö –∏ –≤ –ø—É—Ç–∏" Ozon.
    """

    # –ó–∞–ø—Ä–æ—Å –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É
    print("=" * 60)
    print("–°–û–ó–î–ê–ù–ò–ï –°–í–û–î–ù–û–ô –¢–ê–ë–õ–ò–¶–´ –ü–û –ö–õ–ê–°–¢–ï–†–ê–ú")
    print("=" * 60)

    while True:
        file_path = input("–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É Excel: ").strip()

        if not file_path:
            print("‚ùå –ü—É—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
            continue

        if not os.path.exists(file_path):
            print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
            continue

        break

    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª Excel
        print(f"\nüìÇ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª: {file_path}")
        wb = load_workbook(file_path)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ª–∏—Å—Ç–∞ "–¢–æ–≤–∞—Ä-—Å–∫–ª–∞–¥"
        if "–¢–æ–≤–∞—Ä-—Å–∫–ª–∞–¥" not in wb.sheetnames:
            print("‚ö†Ô∏è  –õ–∏—Å—Ç '–¢–æ–≤–∞—Ä-—Å–∫–ª–∞–¥' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–∏—Å—Ç—ã: {wb.sheetnames}")

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
            sheet_name = wb.sheetnames[0]
            print(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏—Å—Ç: '{sheet_name}'")
        else:
            sheet_name = "–¢–æ–≤–∞—Ä-—Å–∫–ª–∞–¥"

        # –ß–∏—Ç–∞–µ–º –ª–∏—Å—Ç –≤ DataFrame
        df = pd.read_excel(file_path, sheet_name=sheet_name)
        print(f"üìà –ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: {len(df)}")

        # –£–¥–∞–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ (3 –∏ 4 —Å—Ç—Ä–æ–∫–∏ - –∏–Ω–¥–µ–∫—Å—ã 2 –∏ 3)
        if len(df) >= 4:
            df = df.drop([2, 3]).reset_index(drop=True)
            print("üóëÔ∏è  –£–¥–∞–ª–µ–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ 3 –∏ 4")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö...")
        print(f"–°—Ç–æ–ª–±—Ü—ã: {list(df.columns)}")
        print(f"\n–ü–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö:")
        print(df.head(2))

        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –æ–±—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
        # H - –î–æ—Å—Ç—É–ø–Ω–æ –∫ –ø—Ä–æ–¥–∞–∂–µ (–∏–Ω–¥–µ–∫—Å 7), Q - –í –∑–∞—è–≤–∫–∞—Ö –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É (–∏–Ω–¥–µ–∫—Å 16), R - –í –ø–æ—Å—Ç–∞–≤–∫–∞—Ö –≤ –ø—É—Ç–∏ (–∏–Ω–¥–µ–∫—Å 17)
        print("\nüìä –°–æ–∑–¥–∞—é —Å—Ç–æ–ª–±–µ—Ü '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'...")
        df["–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"] = df.iloc[:, 7] + df.iloc[:, 16] + df.iloc[:, 17]

        # –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        print("üìä –°–æ–∑–¥–∞—é —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É...")
        pivot_df = df.pivot_table(
            index="–ê—Ä—Ç–∏–∫—É–ª",
            columns="–ö–ª–∞—Å—Ç–µ—Ä",
            values="–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
            aggfunc="sum",
            fill_value=None,  # –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è None (–±—É–¥–µ—Ç –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –≤ Excel)
        )

        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å, —á—Ç–æ–±—ã –ê—Ä—Ç–∏–∫—É–ª —Å—Ç–∞–ª –æ–±—ã—á–Ω—ã–º —Å—Ç–æ–ª–±—Ü–æ–º
        pivot_df.reset_index(inplace=True)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–æ–≤—ã–π –ª–∏—Å—Ç "–ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º" –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ
        with pd.ExcelWriter(
            file_path, engine="openpyxl", mode="a", if_sheet_exists="replace"
        ) as writer:
            # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
            if "–ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º" in writer.book.sheetnames:
                del writer.book["–ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º"]

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
            pivot_df.to_excel(writer, sheet_name="–ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º", index=False)

            # –ü–æ–ª—É—á–∞–µ–º –ª–∏—Å—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            ws = writer.book["–ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º"]

            # –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
            for column in ws.columns:
                max_length = 0
                column_letter = column[0].column_letter
                for cell in column:
                    try:
                        if cell.value is not None and len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = min(max_length + 2, 30)
                ws.column_dimensions[column_letter].width = adjusted_width

        print(
            f"\n‚úÖ –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –≤ –ª–∏—Å—Ç–µ '–ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º' —Ñ–∞–π–ª–∞ {file_path}"
        )
        print(
            f"üìä –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: {pivot_df.shape[0]} —Å—Ç—Ä–æ–∫ √ó {pivot_df.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤"
        )

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        print("\nüëÅÔ∏è  –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):")
        print(pivot_df.head())

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        print(f"\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   - –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤: {pivot_df.shape[0]}")
        print(f"   - –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: {pivot_df.shape[1] - 1}")
        print(
            f"   - –í—Å–µ–≥–æ —è—á–µ–µ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏: {(pivot_df.notna().sum().sum() - pivot_df.shape[0])}"
        )

    except FileNotFoundError:
        print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
    except KeyError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ç–æ–ª–±–µ—Ü {e}")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Ozon")
    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        import traceback

        traceback.print_exc()


# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
if __name__ == "__main__":
    create_pivot_table()

    # –ü–∞—É–∑–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
